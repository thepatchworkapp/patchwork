{
  "version": 3,
  "sources": ["../../@convex-dev/better-auth/src/plugins/convex/client.ts", "../../@convex-dev/better-auth/src/plugins/cross-domain/client.ts"],
  "sourcesContent": ["import type { BetterAuthClientPlugin } from \"better-auth/client\";\nimport type { convex } from \"./index.js\";\n\nexport const convexClient = () => {\n  return {\n    id: \"convex\",\n    $InferServerPlugin: {} as ReturnType<typeof convex>,\n  } satisfies BetterAuthClientPlugin;\n};\n", "import type { BetterAuthClientPlugin, ClientStore } from \"better-auth\";\nimport type { BetterFetchOption } from \"@better-fetch/fetch\";\nimport type { crossDomain } from \"./index.js\";\n\ninterface CookieAttributes {\n  value: string;\n  expires?: Date;\n  \"max-age\"?: number;\n  domain?: string;\n  path?: string;\n  secure?: boolean;\n  httpOnly?: boolean;\n  sameSite?: \"Strict\" | \"Lax\" | \"None\";\n}\n\nexport function parseSetCookieHeader(\n  header: string\n): Map<string, CookieAttributes> {\n  const cookieMap = new Map<string, CookieAttributes>();\n  const cookies = header.split(\", \");\n  cookies.forEach((cookie) => {\n    const [nameValue, ...attributes] = cookie.split(\"; \");\n    const [name, value] = nameValue.split(\"=\");\n\n    const cookieObj: CookieAttributes = { value };\n\n    attributes.forEach((attr) => {\n      const [attrName, attrValue] = attr.split(\"=\");\n      cookieObj[attrName.toLowerCase() as \"value\"] = attrValue;\n    });\n\n    cookieMap.set(name, cookieObj);\n  });\n\n  return cookieMap;\n}\n\ninterface StoredCookie {\n  value: string;\n  expires: Date | null;\n}\n\nexport function getSetCookie(header: string, prevCookie?: string) {\n  const parsed = parseSetCookieHeader(header);\n  let toSetCookie: Record<string, StoredCookie> = {};\n  parsed.forEach((cookie, key) => {\n    const expiresAt = cookie[\"expires\"];\n    const maxAge = cookie[\"max-age\"];\n    const expires = expiresAt\n      ? new Date(String(expiresAt))\n      : maxAge\n        ? new Date(Date.now() + Number(maxAge) * 1000)\n        : null;\n    toSetCookie[key] = {\n      value: cookie[\"value\"],\n      expires,\n    };\n  });\n  if (prevCookie) {\n    try {\n      const prevCookieParsed = JSON.parse(prevCookie);\n      toSetCookie = {\n        ...prevCookieParsed,\n        ...toSetCookie,\n      };\n    } catch {\n      //\n    }\n  }\n  return JSON.stringify(toSetCookie);\n}\n\nexport function getCookie(cookie: string) {\n  let parsed = {} as Record<string, StoredCookie>;\n  try {\n    parsed = JSON.parse(cookie) as Record<string, StoredCookie>;\n  } catch {\n    // noop\n  }\n  const toSend = Object.entries(parsed).reduce((acc, [key, value]) => {\n    if (value.expires && value.expires < new Date()) {\n      return acc;\n    }\n    return `${acc}; ${key}=${value.value}`;\n  }, \"\");\n  return toSend;\n}\n\nexport const crossDomainClient = (\n  opts: {\n    storage?: {\n      setItem: (key: string, value: string) => any;\n      getItem: (key: string) => string | null;\n    };\n    storagePrefix?: string;\n    disableCache?: boolean;\n  } = {}\n) => {\n  let store: ClientStore | null = null;\n  const cookieName = `${opts?.storagePrefix || \"better-auth\"}_cookie`;\n  const localCacheName = `${opts?.storagePrefix || \"better-auth\"}_session_data`;\n  const storage =\n    opts?.storage || (typeof window !== \"undefined\" ? localStorage : undefined);\n\n  return {\n    id: \"cross-domain\",\n    $InferServerPlugin: {} as ReturnType<typeof crossDomain>,\n    getActions(_, $store) {\n      store = $store;\n      return {\n        /**\n         * Get the stored cookie.\n         *\n         * You can use this to get the cookie stored in the device and use it in your fetch\n         * requests.\n         *\n         * @example\n         * ```ts\n         * const cookie = client.getCookie();\n         * fetch(\"https://api.example.com\", {\n         * \theaders: {\n         * \t\tcookie,\n         * \t},\n         * });\n         */\n        getCookie: () => {\n          const cookie = storage?.getItem(cookieName);\n          return getCookie(cookie || \"{}\");\n        },\n        /**\n         * Notify the session signal.\n         *\n         * This is used to trigger an update in useSession, generally when a new session\n         * token is set.\n         *\n         * @example\n         * ```ts\n         * client.notifySessionSignal();\n         * ```\n         */\n        updateSession: () => {\n          $store.notify(\"$sessionSignal\");\n        },\n        /**\n         * Get the stored session data.\n         *\n         * @example\n         * ```ts\n         * const sessionData = client.getSessionData();\n         * ```\n         */\n        getSessionData: () => {\n          const sessionData = storage?.getItem(localCacheName);\n          return sessionData ? JSON.parse(sessionData) : null;\n        },\n      };\n    },\n    fetchPlugins: [\n      {\n        id: \"convex\",\n        name: \"Convex\",\n        hooks: {\n          async onSuccess(context) {\n            if (!storage) {\n              return;\n            }\n            const setCookie = context.response.headers.get(\n              \"set-better-auth-cookie\"\n            );\n            if (setCookie) {\n              const prevCookie = storage.getItem(cookieName);\n              const toSetCookie = getSetCookie(\n                setCookie || \"\",\n                prevCookie ?? undefined\n              );\n              await storage.setItem(cookieName, toSetCookie);\n              // Only notify on session cookie set\n              if (setCookie.includes(\".session_token=\")) {\n                store?.notify(\"$sessionSignal\");\n              }\n            }\n\n            if (\n              context.request.url.toString().includes(\"/get-session\") &&\n              !opts?.disableCache\n            ) {\n              const data = context.data;\n              storage.setItem(localCacheName, JSON.stringify(data));\n            }\n          },\n        },\n        async init(url, options) {\n          if (!storage) {\n            return {\n              url,\n              options: options as BetterFetchOption,\n            };\n          }\n          options = options || {};\n          const storedCookie = storage.getItem(cookieName);\n          const cookie = getCookie(storedCookie || \"{}\");\n          options.credentials = \"omit\";\n          options.headers = {\n            ...options.headers,\n            \"Better-Auth-Cookie\": cookie,\n          };\n          if (url.includes(\"/sign-out\")) {\n            await storage.setItem(cookieName, \"{}\");\n            store?.atoms.session?.set({\n              data: null,\n              error: null,\n              isPending: false,\n            });\n            storage.setItem(localCacheName, \"{}\");\n          }\n          return {\n            url,\n            options: options as BetterFetchOption,\n          };\n        },\n      },\n    ],\n  } satisfies BetterAuthClientPlugin;\n};\n"],
  "mappings": "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",
  "names": []
}
